<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Set Attendance Location</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            position: relative; 
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100%; 
            background-color: #f0f2f5; 
            width: 100%;
            box-sizing: border-box;
            padding: 1rem 0; 
        }
        .container { 
            background-color: #fff; 
            padding: 1.5rem; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            text-align: center; 
            width: 90%; 
            max-width: 600px; 
            margin-top: 4rem; 
            margin-bottom: 1rem;
        }
        h1 { 
            margin-top: 0; 
            margin-bottom: 1rem; 
            color: #d9534f; /* Red title */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            font-size: 1.5em; 
        }
        h1 svg { 
            width: 1.5rem;
            height: 1.5rem;
        }
        .form-group { margin-bottom: 1rem; text-align: left; }
        label { display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.9em; }
        input { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn { background-color: #d9534f; /* Red */ color: white; padding: 0.75rem 1rem; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1em; font-weight: 600; transition: background-color 0.3s; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background-color: #aaa; }
        #message { font-weight: 600; margin-top: 1rem; padding: 0.75rem; border-radius: 5px; font-size: 0.9em; }
        .success { color: #2b7d2b; background-color: #d4edda; }
        .error { color: #721c24; background-color: #f8d7da; }
        .hidden-details { display: none; }

        .home-btn {
            position: absolute;
            top: 1rem; 
            left: 1rem; 
            display: flex;
            align-items: center;
            background-color: #d9534f; /* Red */
            color: white;
            padding: 0.5rem 0.75rem; 
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85em; 
            transition: background-color 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10; 
        }
        .home-btn:hover {
            opacity: 0.9; 
        }
        .home-btn svg {
            width: 16px; 
            height: 16px;
            margin-right: 4px; 
        }
    </style>
</head>
<body>
    <a href="./index.html" class="home-btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
        </svg>
        Home
    </a>

    <div class="container">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Go to Admin Page
        </h1>
        
        <!-- Password Section -->
        <form id="passwordForm">
            <div class="form-group">
                <label for="adminPassword">Admin Password</label>
                <input type="password" id="adminPassword" required>
            </div>
            <button type="submit" id="verifyBtn" class="btn">Verify Password</button>
        </form>
        
        <!-- Session Details Section -->
        <form id="sessionForm" class="hidden-details">
            <p style="margin-top: 1.5rem; font-weight: 600; color: #333;">Password Verified. Set session details:</p>
            
            <div class="form-group">
                <label for="sessionName">Session Name (for new sheet tab)</label>
                <input type="text" id="sessionName" required>
            </div>
            
            <div class="form-group flex flex-col sm:flex-row sm:justify-between gap-4">
                <div class="w-full sm:w-1/2">
                    <label for="startTime">Start Time</label>
                    <input type="datetime-local" id="startTime" required>
                </div>
                <div class="w-full sm:w-1/2">
                    <label for="endTime">End Time</label>
                    <input type="datetime-local" id="endTime" required>
                </div>
            </div>
            
            <button type="submit" id="setLocationBtn" class="btn mt-4">Set Location & Open Attendance</button>
        </form>
        
        <div id="message"></div>
    </div>

    <script>
        const passwordForm = document.getElementById('passwordForm');
        const sessionForm = document.getElementById('sessionForm');
        const verifyBtn = document.getElementById('verifyBtn');
        const setLocationBtn = document.getElementById('setLocationBtn');
        const messageDiv = document.getElementById('message');
        const adminPasswordField = document.getElementById('adminPassword');
        const sessionNameField = document.getElementById('sessionName'); // Get session name input
        
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwCjH23ufU7dh1F1HlgTk_UY8n0wcJxsMJ0TbihPk3zSiIFiX2UdPwmrANHmrjOtm9FKA/exec"; 
        
        function getLocalDateTimeString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // --- [MODIFIED] DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default times immediately
            const now = new Date();
            const fifteenMinutesLater = new Date(now.getTime() + 15 * 60000);
            document.getElementById('startTime').value = getLocalDateTimeString(now);
            document.getElementById('endTime').value = getLocalDateTimeString(fifteenMinutesLater);

            // Fetch sheet names to suggest a unique session name
            fetch(SCRIPT_URL + "?action=getSheetNames") // Add action parameter
                .then(response => response.json())
                .then(data => {
                    if (data.result === "success" && data.data.sheetNames) {
                        const existingNames = data.data.sheetNames;
                        const dateStr = now.toISOString().split('T')[0];
                        const baseName = `${dateStr} Lecture`;
                        let uniqueName = baseName;
                        let counter = 2;
                        // Keep adding _X until the name is unique
                        while (existingNames.includes(uniqueName)) {
                            uniqueName = `${baseName}_${counter}`;
                            counter++;
                        }
                        sessionNameField.value = uniqueName; // Set the unique name
                    } else {
                        // Fallback if fetching names fails
                        const dateStr = now.toISOString().split('T')[0];
                        sessionNameField.value = `${dateStr} Lecture`; 
                    }
                })
                .catch(error => {
                    console.error("Error fetching sheet names:", error);
                    // Fallback on error
                    const dateStr = now.toISOString().split('T')[0];
                    sessionNameField.value = `${dateStr} Lecture`;
                });
        });
        // --- End DOMContentLoaded ---
        
        passwordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const password = adminPasswordField.value;
            if (!password) {
                showMessage('Please enter the password.', 'error');
                return;
            }
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';
            showMessage('');
            const formData = new FormData();
            formData.append("action", "verifyPassword"); 
            formData.append("password", password);
            fetch(SCRIPT_URL, { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    if (data.result === "success") {
                        passwordForm.style.display = 'none';
                        sessionForm.classList.remove('hidden-details');
                        showMessage(''); 
                    } else {
                        throw new Error(data.data.message || "Verification failed");
                    }
                })
                .catch(error => {
                    showMessage(error.message, 'error');
                    verifyBtn.disabled = false; 
                    verifyBtn.textContent = 'Verify Password';
                });
        });

        sessionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const password = adminPasswordField.value; 
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const sessionName = sessionNameField.value; // Use the (potentially edited) value
            if (!password || !startTime || !endTime || !sessionName) {
                showMessage('Please fill in all fields.', 'error');
                return;
            }
            setLocationBtn.disabled = true;
            setLocationBtn.textContent = 'Getting location...';
            showMessage('');
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    setLocationBtn.textContent = 'Setting location...';
                    const formData = new FormData();
                    formData.append("action", "setLocation");
                    formData.append("password", password); 
                    formData.append("latitude", position.coords.latitude);
                    formData.append("longitude", position.coords.longitude);
                    formData.append("startTime", startTime); 
                    formData.append("endTime", endTime);     
                    formData.append("sessionName", sessionName); 
                    fetch(SCRIPT_URL, { method: 'POST', body: formData })
                        .then(response => response.json())
                        .then(data => {
                            if (data.result === "success") {
                                showMessage(data.data.message, 'success');
                            } else {
                                throw new Error(data.data.message);
                            }
                        })
                        .catch(error => showMessage(error.message, 'error'))
                        .finally(() => {
                            setLocationBtn.disabled = false;
                            setLocationBtn.textContent = 'Set Location & Open Attendance';
                        });
                },
                function(error) {
                    showMessage('Error: Could not get location. Please allow access.', 'error');
                    setLocationBtn.disabled = false;
                    setLocationBtn.textContent = 'Set Location & Open Attendance';
                },
                { enableHighAccuracy: true }
            );
        });

        function showMessage(message, type) {
            messageDiv.textContent = message;
            messageDiv.className = type;
        }
    </script>
</body>
</html>

