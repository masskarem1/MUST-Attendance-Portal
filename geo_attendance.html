<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Course Attendance</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Set Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
            position: relative;
            min-height: 100vh;
        }
        
        /* Glassmorphism card effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        /* Mobile-first: Full-screen card on mobile */
        .glass-card {
            width: 100%;
            height: 100vh;
            border-radius: 0;
            border: none;
            box-shadow: none;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.75);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        /* On screens 'sm' and larger, it becomes a card again */
        @media (min-width: 640px) {
            .glass-card {
                width: auto;
                height: auto;
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
                background: rgba(255, 255, 255, 0.6);
            }
        }
        
        /* Message & Instruction Styles */
        #message .instructions {
            font-size: 0.8em; font-weight: 500; text-align: left;
            margin-top: 1rem; padding: 0.75rem; background-color: rgba(248, 248, 248, 0.8);
            border-radius: 5px; border: 1px solid rgba(221, 221, 221, 0.8);
        }
        #message {
             font-weight: 600; margin-top: 1.5rem; padding: 0.75rem;
             border-radius: 5px; font-size: 0.9em;
         }
        .success { color: #2b7d2b; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        
        /* Input Styles */
        input {
             width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB;
             border-radius: 0.5rem; font-size: 0.875rem; box-sizing: border-box;
             background-color: rgba(255, 255, 255, 0.5);
         }
        label {
             display: block; font-size: 0.875rem; font-weight: 500;
             color: #374151; margin-bottom: 0.25rem;
         }
        
        /* Newcomer Button Styles */
        .newcomer-actions {
            display: none; margin-top: 1rem; display: flex;
            gap: 1rem; justify-content: center;
        }
        .newcomer-btn {
            padding: 0.5rem 1rem; border-radius: 5px; font-weight: 600;
            cursor: pointer; transition: background-color 0.3s;
            border: none; font-size: 0.9em;
        }
        .newcomer-yes { background-color: #28a745; color: white; }
        .newcomer-yes:hover { background-color: #218838; }
        .newcomer-no { background-color: #ffc107; color: #333; }
        .newcomer-no:hover { background-color: #e0a800; }
        .newcomer-yes:disabled { background-color: #aaa; }

        /* Language Switch Button Style */
        .lang-switch-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: rgba(107, 114, 128, 0.8);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.85em;
            cursor: pointer;
            z-index: 10;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .lang-switch-btn:hover { background-color: #4B5563; }

        /* --- [MODIFIED] Arabic Font Styling --- */
        body[lang="ar"] { 
            font-family: 'Tahoma', sans-serif; 
            direction: rtl; /* Add Right-to-Left direction */
        }
        /* [FIXED] Only align labels to the right */
        body[lang="ar"] label { 
            text-align: right; 
        }
        /* Make newcomer instruction text right-aligned */
        body[lang="ar"] .instructions { 
            text-align: right; 
        } 
        /* Override Tailwind's text-left for forms */
        body[lang="ar"] .text-left {
            text-align: right;
        }
        /* Make sure input text is also right-aligned */
        body[lang="ar"] input {
            text-align: right;
        }
        /* --- End of modifications --- */
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-indigo-200 to-blue-200 flex flex-col items-center justify-center min-h-screen p-0">

    <!-- Language Switch Button -->
    <button id="langSwitchBtn" class="lang-switch-btn">En / Ø¹</button>

    <div class="glass-card w-full max-w-lg p-8 md:p-12 text-center">
        <!-- Logo -->
        <div class="mb-8">
            <a href="./index.html" class="inline-block">
                <img src="https://admission.must.edu.eg/lovable-uploads/a51bf950-39e9-4502-bf1f-fcc9e958e555.png" alt="MUST Logo" class="h-28 w-28 mx-auto">
            </a>
        </div>

        <!-- Title & Subtitle -->
        <h1 id="mainTitle" class="text-2xl font-bold text-gray-900 mb-2">Course Attendance System</h1>
        <p id="subTitle" class="text-gray-700 mb-8">Misr University for Science & Technology</p>

        <form id="attendanceForm" class="text-left px-4 sm:px-0">
            <div class="mb-4">
                <label id="labelStudentID" for="studentID">Student ID (Numbers Only)</label>
                <input type="text" id="studentID" name="studentID"
                       inputmode="numeric" pattern="[0-9]*"
                       required>
            </div>

            <div class="mb-4"> <!-- [MODIFIED] Changed margin from mb-6 to mb-4 -->
                 <label id="labelStudentName" for="studentName">Full Name (Text Only)</label>
                <input type="text" id="studentName" name="studentName"
                       pattern="[A-Za-z\s]+"
                       required>
            </div>

            <!-- --- [NEW FIELD] --- -->
            <div class="mb-6">
                <label id="labelPasscode" for="passcode">Session Passcode (4-Digits)</label>
                <input type="text" id="passcode" name="passcode"
                       inputmode="numeric" pattern="[0-9]{4}"
                       required>
            </div>
            <!-- --- [END NEW FIELD] --- -->


            <button type="submit" id="submitButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 text-base disabled:bg-gray-400 shadow-md hover:shadow-lg">
                Submit Attendance
            </button>
        </form>

        <div id="message"></div>

        <!-- Newcomer action buttons -->
        <div id="newcomerActions" class="newcomer-actions px-4 sm:px-0">
            <button id="newcomerYesBtn" class="newcomer-btn newcomer-yes">Yes, I'm New</button>
            <button id="newcomerNoBtn" class="newcomer-btn newcomer-no">No, Re-enter ID</button>
        </div>
    </div>

    <footer class="mt-8 text-gray-700 text-xs md:text-sm absolute bottom-4">
        <p id="footerText">&copy; Misr University for Science and Technology</p>
    </footer>

    <script>
        // --- Translation Data ---
        const translations = {
            en: {
                pageTitle: "Course Attendance",
                mainTitle: "Course Attendance System",
                subTitle: "Misr University for Science & Technology",
                labelStudentID: "Student ID (Numbers Only)",
                labelStudentName: "Full Name (Text Only)",
                labelPasscode: "Session Passcode (4-Digits)", // [NEW]
                submitButton_submit: "Submit Attendance",
                submitButton_checking: "Checking session...",
                submitButton_gettingLocation: "Getting location...",
                submitButton_verifying: "Verifying ID & location...",
                submitButton_submitted: "Already Submitted",
                submitButton_closed: "Attendance Closed",
                submitButton_error: "No Session", // Changed from "Error"
                newcomerYesBtn_yes: "Yes, I'm New",
                newcomerYesBtn_gettingLocation: "Getting Location...",
                newcomerYesBtn_registering: "Registering...",
                newcomerNoBtn: "No, Re-enter ID",
                footerText: "Â© Misr University for Science and Technology",
                // --- Messages (Keys) ---
                alreadySubmittedDevice: "You have already submitted attendance for this session or registered as a newcomer.",
                sessionCheckError: "There is no session available Now", // Changed from "Error: Could not check session status."
                idNumbersOnly: "Error: Student ID must contain only numbers.",
                nameLettersOnly: "Error: Name must contain only letters and spaces.",
                passcodeInvalid: "Error: Passcode must be 4 numbers.", // [NEW]
                geolocationNotSupported: "Error: Geolocation is not supported by your browser.",
                permissionDenied: "Error: You must allow location access.",
                positionUnavailable: "Error: Location information is unavailable.",
                timeout: "Error: The location request timed out.",
                unknownGeoError: "Error: An unknown error occurred getting location.",
                fixInstructions: `
                    <strong>How to fix:</strong><br>
                    1. Tap the lock icon (ğŸ”’) in your browser's address bar.<br>
                    2. Go to "Permissions" or "Site settings".<br>
                    3. Set "Location" to "Allow" for this site.<br>
                    4. Tap the 'Submit' button again.`,
                registerConfirm: "Please ensure ID, Name, and Passcode are entered correctly before registering.", // [MODIFIED]
                registering: "Registering your details...",
                // --- Server Messages (Keys derived from script output) ---
                invalidPasscode: "Invalid Passcode.", // [NEW]
                sessionNotActive: "Attendance is not currently active. Check the session times.",
                invalidId_askNew: "Student ID not found in the list. Are you a new student?",
                duplicateId_session: "This Student ID has already been recorded for this session.",
                locationDenied: "Attendance Denied: You are {distance} meters away. You must be inside the class.",
                locationDenied_newcomer: "Attendance Denied (Newcomer): You are {distance} meters away.", 
                success: "Attendance Recorded Successfully!",
                newcomerSuccessAndAttendance: "Attendance Recorded & Registered as New Student. Please follow up with the doctor.", 
                newcomerDuplicate: "This ID has already been registered as a newcomer. Please contact admin.",
                unknownServerError: "An unknown server error occurred."
            },
            ar: {
                pageTitle: "ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø§Ø¯Ø©",
                mainTitle: "Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±",
                subTitle: "Ø¬Ø§Ù…Ø¹Ø© Ù…ØµØ± Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§",
                labelStudentID: "Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)",
                labelStudentName: "Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø­Ø±ÙˆÙ ÙÙ‚Ø·)",
                labelPasscode: "Ø±Ù…Ø² Ø§Ù„Ø¬Ù„Ø³Ø© (Ù¤ Ø£Ø±Ù‚Ø§Ù…)", // [NEW]
                submitButton_submit: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±",
                submitButton_checking: "Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø©...",
                submitButton_gettingLocation: "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...",
                submitButton_verifying: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹...",
                submitButton_submitted: "ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„",
                submitButton_closed: "Ø§Ù„Ø­Ø¶ÙˆØ± Ù…ØºÙ„Ù‚",
                submitButton_error: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø©", // Changed
                newcomerYesBtn_yes: "Ù†Ø¹Ù…ØŒ Ø£Ù†Ø§ Ø¬Ø¯ÙŠØ¯",
                newcomerYesBtn_gettingLocation: "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...", 
                newcomerYesBtn_registering: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...",
                newcomerNoBtn: "Ù„Ø§ØŒ Ø³Ø£Ø¹ÙŠØ¯ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„",
                footerText: "Â© Ø¬Ø§Ù…Ø¹Ø© Ù…ØµØ± Ù„Ù„Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§",
                // --- Messages (Keys) ---
                alreadySubmittedDevice: "Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ùˆ Ø³Ø¬Ù„Øª ÙƒØ·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.",
                sessionCheckError: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹", // Changed
                idNumbersOnly: "Ø®Ø·Ø£: Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·.",
                nameLettersOnly: "Ø®Ø·Ø£: Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±ÙˆÙ ÙˆÙ…Ø³Ø§ÙØ§Øª ÙÙ‚Ø·.",
                passcodeInvalid: "Ø®Ø·Ø£: Ø±Ù…Ø² Ø§Ù„Ø¬Ù„Ø³Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù¤ Ø£Ø±Ù‚Ø§Ù….", // [NEW]
                geolocationNotSupported: "Ø®Ø·Ø£: Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.",
                permissionDenied: "Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.",
                positionUnavailable: "Ø®Ø·Ø£: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­Ø©.",
                timeout: "Ø®Ø·Ø£: Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹.",
                unknownGeoError: "Ø®Ø·Ø£: Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.",
                 fixInstructions: `
                    <strong>ÙƒÙŠÙÙŠØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­:</strong><br>
                    Ù¡. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù‚ÙÙ„ (ğŸ”’) ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ù…ØªØµÙØ­.<br>
                    Ù¢. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ "Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª" Ø£Ùˆ "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹".<br>
                    Ù£. Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† "Ø§Ù„Ù…ÙˆÙ‚Ø¹" Ø¥Ù„Ù‰ "Ø³Ù…Ø§Ø­" Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹.<br>
                    Ù¤. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± 'Submit' Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`,
                registerConfirm: "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù…Ø² Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.", // [MODIFIED]
                registering: "Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...",
                 // --- Server Messages (Keys derived from script output) ---
                invalidPasscode: "ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ­ÙŠØ­", // [NEW]
                sessionNotActive: "Attendance is not currently active. Check the session times.",
                invalidId_askNew: "Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. Ù‡Ù„ Ø£Ù†Øª Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ",
                duplicateId_session: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ Ù…Ù† Ù‚Ø¨Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©.",
                locationDenied: "ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø­Ø¶ÙˆØ±: Ø£Ù†Øª Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ {distance} Ù…ØªØ±. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¹Ø©.",
                locationDenied_newcomer: "ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø­Ø¶ÙˆØ± (Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯): Ø£Ù†Øª Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ {distance} Ù…ØªØ±.", 
                success: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!",
                newcomerSuccessAndAttendance: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ¨ÙŠØ§Ù†Ø§ØªÙƒ ÙƒØ·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø§Ù„Ø¯ÙƒØªÙˆØ±.", 
                newcomerDuplicate: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ÙƒØ·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù‚Ø¨Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.",
                unknownServerError: "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…."
            }
        };
        // --- End Translation Data ---

        const form = document.getElementById('attendanceForm');
        const submitButton = document.getElementById('submitButton');
        const messageDiv = document.getElementById('message');
        const newcomerActionsDiv = document.getElementById('newcomerActions');
        const newcomerYesBtn = document.getElementById('newcomerYesBtn');
        const newcomerNoBtn = document.getElementById('newcomerNoBtn');
        const langSwitchBtn = document.getElementById('langSwitchBtn');

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwCjH23ufU7dh1F1HlgTk_UY8n0wcJxsMJ0TbihPk3zSiIFiX2UdPwmrANHmrjOtm9FKA/exec";
        let activeSessionName = null;
        let currentLang = localStorage.getItem('attendanceLang') || 'en';

        // Function to update UI text
        function updateUI(lang) {
            const t = translations[lang];
            document.documentElement.lang = lang;
            document.body.lang = lang;

            document.getElementById('pageTitle').textContent = t.pageTitle;
            document.getElementById('mainTitle').textContent = t.mainTitle;
            document.getElementById('subTitle').textContent = t.subTitle;
            document.getElementById('labelStudentID').textContent = t.labelStudentID;
            document.getElementById('labelStudentName').textContent = t.labelStudentName;
            document.getElementById('labelPasscode').textContent = t.labelPasscode; // [NEW]
            document.getElementById('newcomerYesBtn').textContent = t.newcomerYesBtn_yes;
            document.getElementById('newcomerNoBtn').textContent = t.newcomerNoBtn;
            document.getElementById('footerText').textContent = t.footerText;
            
             const currentSubmitTextKey = submitButton.dataset.textKey || 'submitButton_submit';
             submitButton.textContent = t[currentSubmitTextKey];

            langSwitchBtn.textContent = lang === 'en' ? 'Ø¹' : 'En';
        }

        // Event listener for language switch
        langSwitchBtn.addEventListener('click', () => {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            localStorage.setItem('attendanceLang', currentLang);
            updateUI(currentLang);
            if (messageDiv.dataset.messageKey) {
                 showMessage(messageDiv.dataset.messageKey, messageDiv.className, messageDiv.dataset.messageParams ? JSON.parse(messageDiv.dataset.messageParams) : null);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            updateUI(currentLang); // Set initial language

            submitButton.disabled = true;
            submitButton.dataset.textKey = 'submitButton_checking';
            updateUI(currentLang);
            newcomerActionsDiv.style.display = 'none';

            fetch(SCRIPT_URL)
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        activeSessionName = data.data.sessionName;
                        const deviceLockKey = activeSessionName;

                        if (localStorage.getItem(deviceLockKey) === 'true') {
                            showMessage('alreadySubmittedDevice', 'error');
                            submitButton.dataset.textKey = 'submitButton_submitted';
                        } else {
                            submitButton.disabled = false;
                            submitButton.dataset.textKey = 'submitButton_submit';
                        }
                    } else {
                        showMessageFromServer(data.data.message); // Try to translate server msg
                        submitButton.dataset.textKey = 'submitButton_closed';
                    }
                    updateUI(currentLang); // Update button text again
                })
                .catch(err => {
                    showMessage('sessionCheckError', 'error');
                    submitButton.dataset.textKey = 'submitButton_error';
                    updateUI(currentLang);
                });
        });

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            hideNewcomerButtons();

            const studentID = document.getElementById('studentID').value;
            const studentName = document.getElementById('studentName').value;
            const passcode = document.getElementById('passcode').value; // [NEW]

            if (!/^\d+$/.test(studentID)) {
                showMessage('idNumbersOnly', 'error');
                return;
            }
            if (!/^[A-Za-z\s]+$/.test(studentName)) {
                showMessage('nameLettersOnly', 'error');
                return;
            }
            // [NEW] Passcode validation
            if (!/^\d{4}$/.test(passcode)) {
                showMessage('passcodeInvalid', 'error');
                return;
            }

            submitButton.disabled = true;
            submitButton.dataset.textKey = 'submitButton_gettingLocation';
            updateUI(currentLang);
            showMessage(''); // Clear message

            if (!navigator.geolocation) {
                showMessage('geolocationNotSupported', 'error');
                submitButton.disabled = false;
                 submitButton.dataset.textKey = 'submitButton_submit';
                 updateUI(currentLang);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                geolocationSuccess,
                geolocationError,
                { enableHighAccuracy: true }
            );
        });

        function geolocationSuccess(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const studentID = document.getElementById('studentID').value;
            const studentName = document.getElementById('studentName').value;
            const passcode = document.getElementById('passcode').value; // [NEW]

            submitButton.dataset.textKey = 'submitButton_verifying';
            updateUI(currentLang);

            const formData = new FormData();
            formData.append("action", "takeAttendance");
            formData.append("studentID", studentID);
            formData.append("studentName", studentName);
            formData.append("latitude", userLat);
            formData.append("longitude", userLon);
            formData.append("passcode", passcode); // [NEW]

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === "success") {
                    handleSuccessFromServer(data.data.message);
                } else if (data.result === "invalid_id") {
                    handleInvalidIdFromServer(data.data.message);
                } else {
                    handleErrorFromServer(data.data.message || 'unknownServerError');
                }
            })
            .catch(error => {
                handleError('unknownServerError'); // Assume unknown error on fetch fail
            })
        }

        // Handlers now use server messages
        function handleSuccessFromServer(serverMessage) {
            const key = findKeyByEnglishValue(serverMessage, translations.en);
            showMessage(key || 'success', 'success'); // Fallback to generic key
            form.reset();
            if (activeSessionName) {
                localStorage.setItem(activeSessionName, 'true');
            }
            submitButton.disabled = true;
            submitButton.dataset.textKey = 'submitButton_submitted';
            updateUI(currentLang);
        }

        function handleInvalidIdFromServer(serverMessage) {
            const key = findKeyByEnglishValue(serverMessage, translations.en);
            showMessage(key || 'invalidId_askNew', 'error'); // Fallback to generic key
            showNewcomerButtons();
            submitButton.style.display = 'none';
        }

        function handleErrorFromServer(serverMessage) {
              const key = findKeyByEnglishValue(serverMessage, translations.en);
              let params = null;
              if (key === 'locationDenied' || key === 'locationDenied_newcomer') { 
                   const distanceMatch = serverMessage.match(/(\d+)\s+meters/);
                   if (distanceMatch) { params = { distance: distanceMatch[1] }; }
              }
              showMessage(key || 'unknownServerError', 'error', params);
              submitButton.disabled = false;
              submitButton.dataset.textKey = 'submitButton_submit';
              updateUI(currentLang);
        }
        
        // Helper to find translation key from English server message
        function findKeyByEnglishValue(value, englishTranslations) {
            if (!value) return null;
            if (value.includes("meters away")) {
                 return value.includes("Newcomer") ? 'locationDenied_newcomer' : 'locationDenied';
            }
            // [NEW] Check for new passcode error
            if (value.includes("Invalid Passcode")) {
                return 'invalidPasscode';
            }
            for (const key in englishTranslations) { if (englishTranslations[key] === value) { return key; } }
            if (value.includes("already been recorded for this session")) return 'duplicateId_session';
            if (value.includes("not currently active")) return 'sessionNotActive';
            if (value.includes("already been registered as a newcomer")) return 'newcomerDuplicate';
            if (value.includes("Attendance Recorded & Registered as New Student")) return 'newcomerSuccessAndAttendance';
            return null; 
        }


        function geolocationError(error) {
            let messageKey = '';
            let includeInstructions = false;

            switch(error.code) {
                case error.PERMISSION_DENIED:
                    messageKey = 'permissionDenied';
                    includeInstructions = true;
                    break;
                case error.POSITION_UNAVAILABLE:
                    messageKey = 'positionUnavailable';
                    break;
                case error.TIMEOUT:
                    messageKey = 'timeout';
                    break;
                default:
                    messageKey = 'unknownGeoError';
                    break;
            }
            showMessage(messageKey, 'error', null, includeInstructions);
            submitButton.disabled = false;
            submitButton.dataset.textKey = 'submitButton_submit';
            updateUI(currentLang);
        }

        // showMessage to use keys and handle params/instructions
        function showMessage(key, type, params = null, includeInstructions = false) {
            let messageText = translations[currentLang][key] || translations['en'][key] || key;
            if (params) { for (const pKey in params) { messageText = messageText.replace(`{${pKey}}`, params[pKey]); } }
            let finalHtml = messageText; if (includeInstructions) { finalHtml += `<div class="instructions">${translations[currentLang]['fixInstructions']}</div>`; }
            messageDiv.innerHTML = finalHtml;
            messageDiv.className = type;
            messageDiv.dataset.messageKey = key;
            messageDiv.dataset.messageParams = params ? JSON.stringify(params) : "";
        }


        function showNewcomerButtons() {
            newcomerActionsDiv.style.display = 'flex';
            newcomerYesBtn.disabled = false;
            newcomerYesBtn.textContent = translations[currentLang].newcomerYesBtn_yes; // Use translation
            newcomerNoBtn.textContent = translations[currentLang].newcomerNoBtn; // Use translation
        }
        function hideNewcomerButtons() {
            newcomerActionsDiv.style.display = 'none';
        }

        newcomerNoBtn.addEventListener('click', () => {
            hideNewcomerButtons();
            submitButton.style.display = 'block';
            submitButton.disabled = false;
            submitButton.dataset.textKey = 'submitButton_submit';
            updateUI(currentLang);
            showMessage('');
            document.getElementById('studentID').focus();
        });

        // --- [MODIFIED] Event listener for "Yes, I'm New" button ---
        newcomerYesBtn.addEventListener('click', () => {
            const studentID = document.getElementById('studentID').value;
            const studentName = document.getElementById('studentName').value;
            const passcode = document.getElementById('passcode').value; // [NEW]

            // [MODIFIED] Added passcode validation
            if (!/^\d+$/.test(studentID) || !/^[A-Za-z\s]+$/.test(studentName) || !/^\d{4}$/.test(passcode)) {
                showMessage('registerConfirm', 'error');
                showNewcomerButtons();
                return;
            }

            // --- Get location FIRST ---
            newcomerYesBtn.disabled = true;
            newcomerYesBtn.textContent = translations[currentLang].newcomerYesBtn_gettingLocation; // Getting location text
            showMessage(''); // Clear previous error

            if (!navigator.geolocation) {
                showMessage('geolocationNotSupported', 'error');
                newcomerYesBtn.disabled = false; // Re-enable on error
                newcomerYesBtn.textContent = translations[currentLang].newcomerYesBtn_yes;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) { // --- On Location Success ---
                    newcomerYesBtn.textContent = translations[currentLang].newcomerYesBtn_registering; // Registering text
                    showMessage('registering', ''); // Show 'Registering...' message

                    const formData = new FormData();
                    formData.append("action", "registerNewcomer");
                    formData.append("studentID", studentID);
                    formData.append("studentName", studentName);
                    formData.append("latitude", position.coords.latitude); // Send location
                    formData.append("longitude", position.coords.longitude);// Send location
                    formData.append("passcode", passcode); // [NEW]

                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.result === 'success') {
                            const key = findKeyByEnglishValue(data.data.message, translations.en)
                            showMessage(key || 'newcomerSuccessAndAttendance', 'success'); // Use new combined key
                            hideNewcomerButtons();
                            form.reset();
                            if (activeSessionName) {
                                localStorage.setItem(activeSessionName, 'true'); // Lock device
                            }
                            submitButton.style.display = 'block';
                            submitButton.disabled = true;
                            submitButton.dataset.textKey = 'submitButton_submitted';
                            updateUI(currentLang);
                        } else {
                            // Handle specific errors like location denied or invalid passcode
                            handleErrorFromServer(data.data.message || 'unknownServerError');
                            // Re-enable Yes button on server error
                            newcomerYesBtn.disabled = false;
                            newcomerYesBtn.textContent = translations[currentLang].newcomerYesBtn_yes;

                        }
                    })
                    .catch(error => { // Catch fetch error
                         showMessage('unknownServerError', 'error');
                         newcomerYesBtn.disabled = false;
                         newcomerYesBtn.textContent = translations[currentLang].newcomerYesBtn_yes;
                    });

                },
                function(error) { // --- On Location Error ---
                    geolocationError(error); // Use existing geo error handler
                    newcomerYesBtn.disabled = false; // Re-enable button
                    newcomerYesBtn.textContent = translations[currentLang].newcomerYesBtn_yes;
                },
                { enableHighAccuracy: true }
            );
            // --- End location getting ---
        });

    </script>
</body>
</html>
